{% extends "base.html" %}
{% block title %}Escrevendo post{% endblock %}
{% block content %}
<body class="bg-[#F2FAFE]">
	{% include 'navbar.html' %}
	<div class="max-w-2xl mx-auto p-6 mt-10 bg-white rounded-lg shadow-2xl">
		<h1 class="text-2xl font-bold mb-4">Criar Novo Post</h1>
		{% with messages = get_flashed_messages(with_categories=true) %}
			{% if messages %}
				{% for category, message in messages %}
					<div class="p-2 mb-4 text-white {{ 'bg-green-500' if category == 'success' else 'bg-red-500' }} rounded">
						{{ message }}
					</div>
				{% endfor %}
			{% endif %}
		{% endwith %}
		<form method="POST" id="postForm" enctype="multipart/form-data" class="max-w-2xl mx-auto p-6 mt-6">
			{{ form.hidden_tag() }}
			<div class="mb-4">
				<input type="text" id="tituloInput" name="tituloInput" minlength="3" maxlength="100" placeholder="Digite seu título aqui" class="w-full p-2 border text-gray-700 rounded" required>
				<div class="flex justify-end">
					<p id="tituloInputCounter" class="text-gray-500 text-sm mt-1 hidden">0 / 100</p>
				</div>
			</div>
			<div class="mb-4 flex space-x-4">
				<div class="w-1/2">
					<select class="w-full p-2 border text-gray-700 rounded" name="tags" id="tags" required>
						<option value="" selected disabled>Selecione uma categoria...</option>
						{% for value in form.tags.iter_choices() %}
							<option value="{{ value[0] }}">{{ value[1] }}</option>
						{% endfor %}
					</select>
				</div>
				<div class="w-1/2 relative">
					<select class="w-full p-2 border text-gray-700 rounded appearance-none" id="optionalTags" size="1" onchange="toggleSelectedTag(this)">
						<option value="" disabled selected>Tags opcionais...</option>
						{% for value in allowed_categories %}
							<option value="{{ value }}">{{ value }}</option>
						{% endfor %}
					</select>
					<input type="hidden" name="hiddenOptionalTags" id="hiddenOptionalTags">
					<div id="selectedTags" class="mt-2 flex flex-wrap gap-2"></div>
				</div>
			</div>
			<div class="mb-4">
				<textarea id="contentTextarea" name="contentTextarea" minlength="30" maxlength="2000" placeholder="Selecione uma categoria antes de escrever." class="w-full h-40 p-2 border text-gray-700 rounded" required></textarea>
				<div class="flex justify-end">
					<p id="contentTextareaCounter" class="text-gray-500 text-sm mt-1 hidden">0 / 2000</p>
				</div>
			</div>
			<div class="mb-4">
				<input type="file" id="inputFiles" name="inputFiles" accept="image/*" multiple onchange="previewImages(event)" class="mb-2 border rounded p-2 hover:bg-gray-200 transition">
				<div id="imagePreview" class="flex space-x-2"></div>
			</div>
			<button id="submitPostBtn" type="submit" class="bg-blue-500 text-white px-4 py-2 rounded cursor-pointer disabled:bg-[#E0E7FF] disabled:cursor-not-allowed disabled:text-[#6366F1]">Publicar</button>
		</form>
	</div>
</body>
{% endblock %}
{% block scripts %}
<script>
	let selectedTags = [];
	function toggleSelectedTag(select) {
		const value = select.value;
		if (!value) return;

		const index = selectedTags.indexOf(value);
		if (index === -1) {
			if (selectedTags.length >= 5) {
				alert('Maximum 5 optional tags allowed!');
				select.value = '';
				return;
			}
			selectedTags.push(value);
		} else {
			selectedTags.splice(index, 1);
		}

		updateSelectedTagsDisplay();
		select.value = '';
	}

	function updateSelectedTagsDisplay() {
		const display = document.getElementById('selectedTags');
		const hiddenInput = document.getElementById('hiddenOptionalTags');
		display.innerHTML = '';

		selectedTags.forEach(tag => {
			const tagElement = document.createElement('span');
			tagElement.className = 'bg-blue-200 px-2 py-1 rounded flex items-center';
			tagElement.textContent = tag;
			const removeButton = document.createElement('button');
			removeButton.textContent = '×';
			removeButton.className = 'ml-2 text-red-400 hover:text-red-300';
			removeButton.onclick = () => {
				selectedTags = selectedTags.filter(t => t !== tag);
				updateSelectedTagsDisplay();
			};
			tagElement.appendChild(removeButton);
			display.appendChild(tagElement);
		});

		hiddenInput.value = selectedTags.join(',');
	}

	function previewImages(event) {
		const preview = document.getElementById('imagePreview');
		preview.innerHTML = '';
		const files = event.target.files;
		if (files.length > 5) {
			alert('Maximum 5 images allowed!');
			event.target.value = '';
			return;
		}
		for (let i = 0; i < files.length; i++) {
			const img = document.createElement('img');
			img.src = URL.createObjectURL(files[i]);
			img.style.width = '100px';
			img.style.height = '100px';
			img.onmouseover = () => img.style.transform = 'scale(1.1)';
			img.onmouseout = () => img.style.transform = 'scale(1)';
			preview.appendChild(img);
		}
	}

	// Arrasta e solta de arquivos
	const postForm = document.getElementById('postForm');
	const inputFiles = document.getElementById('inputFiles');
	postForm.addEventListener('dragover', (e) => e.preventDefault());
	postForm.addEventListener('drop', (e) => {
		e.preventDefault();
		const files = e.dataTransfer.files;
		const dataTransfer = new DataTransfer();
		for (let i = 0; i < files.length && i < 5; i++) {
			dataTransfer.items.add(files[i]);
		}
		inputFiles.files = dataTransfer.files;
		previewImages({ target: inputFiles });
	});

	const submitBtn = document.getElementById('submitPostBtn');
	postForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		toggleLoading(submitBtn);

		const oldErrorMessages = postForm.querySelectorAll('.error-message');
		oldErrorMessages.forEach(msg => msg.remove());
		postForm.querySelectorAll('input, textarea, select').forEach(el => el.classList.remove('border-red-500'));

		const formData = new FormData(postForm);
	
		const result = await sendFormAsAjax("{{ url_for('posts.create_post') }}", formData)
		if (result.success) {
			window.location.pathname = `/post/${result.message}`
		} else {
			if (result.errors) {
				for (const fieldName in result.errors) {
					const messages = result.errors[fieldName];
					const inputElement = document.getElementsByName(fieldName)[0];
					if (inputElement) {
						inputElement.classList.add('border-red-500');
						const parent = inputElement.closest('div');
						messages.forEach(msg => {
							const errorMessage = document.createElement('p');
							errorMessage.className = 'text-red-500 text-xs mt-1 error-message';
							errorMessage.textContent = msg;
							parent.appendChild(errorMessage);
						});
					}
				}
			} else if (result.message) {
				alert(result.message);
			}
		}
		toggleLoading(submitBtn);
	});
</script>
{% endblock %}