{% extends "base.html" %}
{% block title %}@{{ user.username }}{% endblock %}
{% block description %}{{ user.bio or 'Sem biografia ainda.' }}{% endblock %}
{% block additional_styles %}
<meta property="og:image" content="{{ user.banner_url or 'https://parentalia-cloud-bucket.s3.sa-east-1.amazonaws.com/public/static/BackgroundTimby.jpg' }}" />
<meta property="twitter:image" content="{{ user.banner_url or 'https://parentalia-cloud-bucket.s3.sa-east-1.amazonaws.com/public/static/BackgroundTimby.jpg' }}" />
<meta property="twitter:card" content="{{ user.banner_url or 'https://parentalia-cloud-bucket.s3.sa-east-1.amazonaws.com/public/static/BackgroundTimby.jpg' }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='posts.css') }}">
<style>
	.profile-banner {
		min-height: 180px;
		border-radius: 1.5rem 1.5rem 0 0;
		position: relative;
		background: linear-gradient(135deg, #3b82f6 60%, #60a5fa 100%);
		overflow: hidden;
	}
	.profile-banner-img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		position: absolute;
		top: 0;
		left: 0;
		z-index: 0;
	}
	.profile-banner-gradient {
		position: absolute;
		inset: 0;
		background: linear-gradient(135deg, #3b82f6 60%, #60a5fa 100%);
		opacity: 0.5;
		pointer-events: none;
	}
	.badge-icon {
		transition: transform 0.1s;
	}
	.badge-icon:hover {
		transform: scale(1.08);
	}
	@media screen and (max-width: 640px) {
		.profile-banner {
			border-radius: 0;
		}
	}
</style>
{% endblock %}
{% block content %}
{% include 'navbar.html' %}
{% include 'popups.html' %}
<body class="bg-[#F2FAFE] flex flex-col items-center w-full min-h-screen py-0 sm:py-2 md:py-8">
	<div class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl relative">
		<div class="profile-banner">
			{% if user.banner_url %}
				<img src="{{ user.banner_url }}" alt="Banner do perfil" class="profile-banner-img">
			{% else %}
				<div class="profile-banner-gradient"></div>
			{% endif %}
		</div>
		<div class="profile-card flex items-end justify-between absolute px-6 top-[120px] w-full" data-user-id="{{ user.id }}" >
			<div class="shadow-lg w-[120px] h-[120px] bg-gray-200 border-[5px] border-white rounded-[25%] flex items-center justify-center overflow-hidden">
				{% if user.profile_image_url %}
					<img src="{{ user.profile_image_url }}" alt="Foto de perfil" class="object-cover w-full h-full rounded">
				{% else %}
					<i class="fa-solid fa-user text-blue-500 text-6xl"></i>
				{% endif %}
			</div>
			<div class="flex items-center gap-2">
				{% if can_edit_profile %}
				<a id="editProfileBtn" class="mt-4 md:mt-0 bg-white border border-blue-500 text-blue-600 cursor-pointer hover:bg-blue-600 hover:text-white font-semibold px-6 py-2 rounded-full transition">Editar Perfil</a>
				{% endif %}
				<button class="options-button cursor-pointer text-gray-500 hover:text-blue-700 focus:outline-none rounded-full border w-9 h-9 flex items-center justify-center"><i class="fas fa-ellipsis-v text-xl"></i></button>
			</div>
		</div> 
		<div class="pt-17 pb-6 px-8 flex flex-col items-start">
			<div class="flex flex-col items-start md:flex-row md:items-center w-full justify-between">
				<div>
					<h1 class="text-2xl font-bold text-gray-900">{{ user.display_name or user.username}}</h1>
					<div class="text-gray-500 text-base">@{{ user.username }}</div>
				</div>
			</div>
			<div class="text-gray-700 mt-2 mb-2">{{ user.bio or 'Sem biografia ainda.' }}</div>
			<div class="flex flex-wrap gap-4 text-gray-500 text-sm mt-2">
				<div><i class="fa-regular fa-calendar"></i> Entrou em {{ user.creation_date.strftime('%d/%m/%Y') }}</div>
			</div>
		</div>
		<div class="px-8 pb-6">
			<h2 class="text-lg font-semibold text-gray-800 mb-2">Selos</h2>
			<div class="flex flex-wrap items-center">
				{% if user.badges %}
				{% for badge in user.badges %}
				<div class="flex flex-col items-center badge-icon w-24">
					<div class="w-20 h-20 bg-gray-200 rounded-xl flex items-center justify-center shadow-md mb-1 overflow-hidden">
						<img src="{{ badge.icon_url }}" alt="{{ badge.name }}" class="object-cover w-full h-full">
					</div>
					<span class="text-xs text-center text-gray-800 font-semibold truncate w-full" title="{{ badge.name }}">{{ badge.name }}</span>
				</div>
				{% endfor %}
				{% else %}
				<span class="text-gray-400">Nenhum selo ainda.</span>
				{% endif %}
			</div>
		</div>
		<div class="px-8 pb-8">
			<h2 class="text-lg font-semibold text-gray-800 mb-4">Posts</h2>
			<div class="flex flex-col gap-6">
				{% for post in user.posts %}
				<div class="timeline-post post-container tilt-box flex flex-col md:flex-row gap-6 p-6 rounded-lg bg-gray-100 shadow-sm border border-gray-200 hover:border-blue-200 cursor-pointer transition group" data-postid="{{ post.id }}" data-post-userid="{{ post.userid }}">
					<div class="flex-1 flex flex-col justify-between min-w-0">
						<div>
							<div class="flex items-center gap-2 mb-2">
								<span class="profile-pic">
									{% if post.authoricon %}
										<img src="{{ post.authoricon }}" alt="Foto de perfil>" class="object-cover w-9 h-9 rounded-full">
									{% else %}
										<i class="fa-solid fa-user"></i>
									{% endif %}
								</span>
								<a href="/usuario/{{ post.userid }}" class="flex flex-col author-link">
									<span class="font-semibold text-gray-800">{{ post.author or post.authorat }}</span>
									<span class="text-gray-400 text-xs">@{{ post.authorat }}</span>
								</a>
								<span class="text-xs text-gray-500">• {{ post.created_at.strftime('%d/%m/%Y') }}</span>
							</div>
							<h2 class="text-xl font-bold text-gray-900 mb-2 break-words line-clamp-3">{{ post.title }}</h2>
							<div class="flex flex-wrap gap-2 mb-2">
								<span class="bg-blue-500 text-white text-xs font-semibold px-3 py-1 rounded-full">{{ post.tag.upper() }}</span>
							</div>
							<div class="post-content text-gray-700 leading-relaxed text-base md:text-lg my-4">{% if post.content|length > 350 %}{{ post.content[:350] }}... <a target="_blank" href="{{ url_for('posts.view_post', post_id=post.id) }}" class="text-blue-500 hover:underline">Ler Mais</a>{% else %}{{ post.content }}{% endif %}</div>
						</div>
						<div class="flex items-center gap-4 interactions-container">
							<button class="interaction-button like-button cursor-pointer {% if post.user_reaction == 'like_post' %}active{% endif %}" id="like{{ post.id }}Button">
								<i class="fa-solid fa-thumbs-up"></i>
								<span id="like{{ post.id }}Count">{{ post.likes }}</span>
							</button>
							<button class="interaction-button dislike-button cursor-pointer {% if post.user_reaction == 'dislike_post' %}active{% endif %}" id="dislike{{ post.id }}Button">
								<i class="fa-solid fa-thumbs-down"></i>
								<span id="dislike{{ post.id }}Count">{{ post.dislikes }}</span>
							</button>
							<button class="interaction-button cursor-pointer" id="saveButton{{ post.id }}">
								<i class="fa-solid fa-bookmark"></i>
								<span>Salvar</span>
							</button>
						</div>
					</div>
					<div class="flex flex-col justify-between items-end">
						{% if post.image_urls %}
						<div class="image-container relative w-full md:w-48 h-48 flex items-center justify-center bg-gray-200 rounded-lg overflow-hidden cursor-pointer hover:opacity-90 transition-opacity" onclick="openModal('imageModal', '{{ post.image_urls[0] }}')">
							<img src="{{ post.image_urls[0] }}" alt="Imagem do Post" class="object-cover w-full h-full">
							{% if post.image_urls|length > 1 %}
							<div class="absolute inset-0 flex items-center justify-center">
								<span class="bg-black/60 text-white text-lg font-bold px-4 py-2 rounded-full">+{{ post.image_urls|length - 1 }}</span>
							</div>
							{% endif %}
						</div>
						{% endif %}
						<span class="text-sm text-gray-500">{{ post.created_at.strftime('%d/%m/%Y') }}</span>
					</div>
					<button class="options-button self-start cursor-pointer text-gray-500 hover:text-blue-700 focus:outline-none"><i class="fas fa-ellipsis-v text-lg"></i></button>
				</div>
				{% else %}
				<div class="text-gray-400 text-center py-8">Nenhum post ainda.</div>
				{% endfor %}
			</div>
		</div>
	</div>
	<div id="cropModal" class="fixed inset-0 z-[999] flex items-center justify-center bg-blue-500/60 hidden">
		<div class="bg-white rounded-xl shadow-xl p-6 max-w-lg w-full flex flex-col items-center">
			<div class="w-full aspect-video bg-gray-100 flex items-center justify-center overflow-hidden mb-4" style="max-height:400px;">
				<img id="cropImage" class="max-w-full max-h-[400px] object-contain" src="" alt="Crop">
			</div>
			<div class="flex justify-end w-full gap-2">
				<button id="cancelCropBtn" class="px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-100">Cancelar</button>
				<button id="applyCropBtn" class="px-4 py-2 rounded bg-blue-600 text-white font-bold hover:bg-blue-700">Aplicar</button>
			</div>
		</div>
	</div>
	<div id="editProfileModal" class="fixed inset-0 z-50 flex items-center justify-center bg-transparent backdrop-blur-[4px] backdrop-brightness-90 backdrop-contrast-110 backdrop-saturate-120 transition-all duration-200 hidden">
		<div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl relative overflow-hidden">
			<form id="editProfileForm" class="flex flex-col">
				<!-- Banner -->
				<div class="relative h-48 bg-gradient-to-tr from-blue-500 to-blue-300 flex justify-center items-center">
					<img id="editBannerPreview" src="{{ user.banner_url or '' }}" alt="Banner" class="w-full h-full object-cover absolute top-0 left-0 z-0 {% if not user.banner_url %}hidden{% endif %}">
					<input type="file" id="editBannerInput" accept="image/*" class="hidden">
					<div class="flex gap-2">
						<button type="button" id="editBannerBtn" class="bg-black/50 w-9 h-9 cursor-pointer flex items-center justify-center hover:bg-black/80 text-white rounded-full p-2 z-10" title="Alterar banner">
							<i class="fa-solid fa-camera"></i>
						</button>
						<button type="button" id="removeBannerBtn" class="bg-black/50 w-9 h-9 cursor-pointer flex items-center justify-center hover:bg-black/80 text-white rounded-full p-2 z-10 {% if not user.banner_url %}hidden{% endif %}" title="Remover banner">
							<i class="fa-solid fa-xmark"></i>
						</button>
					</div>
				</div>
				<!-- Imagem de perfil -->
				<div class="flex px-8">
					<div class="relative -mt-12 w-24 h-24 rounded-[25%] border-4 border-white shadow-lg bg-gray-200 flex items-center justify-center overflow-hidden">
						{% if user.profile_image_url %}
						<img id="editProfilePicPreview" src="{{ user.profile_image_url }}" alt="Foto de perfil" class="object-cover w-full h-full">
						{% else %}
						<span id="editProfilePicPreview" class="flex items-center justify-center w-full h-full text-blue-500 text-5xl"><i class="fa-solid fa-user"></i></span>
						{% endif %}
						<input type="file" id="editProfilePicInput" accept="image/*" class="hidden">
						<button type="button" id="editProfilePicBtn" class="absolute cursor-pointer bg-black/50 w-9 h-9 flex items-center justify-center hover:bg-black/80 text-white rounded-full p-2" title="Alterar foto">
							<i class="fa-solid fa-camera"></i>
						</button>
					</div>
				</div>
				<!-- Form -->
				<div class="pt-6 pb-8 px-8 flex flex-col gap-4">
					<div id="errors"></div>
					<label class="relative flex items-end w-full h-13 px-4 py-2 rounded-lg cursor-text border border-gray-300 focus-within:ring-2 focus-within:ring-blue-500 bg-white">
						<div class="font-semibold text-gray-500 w-full flex justify-between absolute text-xs top-1 left-2 select-none">
							<span>Nome</span>
							<span id="editDisplayNameCounter" class="mr-4 hidden">{{ 0 if not user.display_name else user.display_name | length }} / 32</span>
						</div>
						<input id="editDisplayName" name="display_name" maxlength="32" class="w-full text-gray-900 focus:outline-none" value="{{ user.display_name if user.display_name else ''}}" required>
					</label>
					<label class="relative flex items-end w-full px-4 py-2 rounded-lg cursor-text border border-gray-300 focus-within:ring-2 focus-within:ring-blue-500 bg-white">
						<div class="_label font-semibold text-gray-500 w-full flex justify-between absolute text-xs top-1 left-2 select-none">
							<span>Bio</span>
							<span id="editBioCounter" class="mr-4 hidden">{{ 0 if not user.bio else user.bio | length }} / 250</span>
						</div>
						<textarea id="editBio" name="bio" maxlength="250" rows="3" class="w-full focus:outline-none mt-4 resize-none text-gray-900"></textarea>
					</label>
					<div class="flex justify-end gap-2 mt-4">
						<span id="closeEditProfileModal" class="bg-white cursor-pointer border border-red-600 text-red-600 hover:bg-red-700 hover:text-white font-bold py-2 px-6 rounded-full transition">Cancelar</span>
						<button id="submitEditProfileForm" type="submit" class="bg-blue-600 hover:bg-blue-700 cursor-pointer text-white font-bold py-2 px-6 rounded-full transition disabled:bg-[#E0E7FF] disabled:cursor-not-allowed disabled:text-[#6366F1]">Salvar</button>
					</div>
				</div>
			</form>
		</div>
	</div>
	<div id="imageModal" class="modal hidden">
		<span class="close-button" onclick="closeModal('imageModal')">&times;</span>
		<img class="image-modal-content" id="fullImage">
	</div>
	<div id="replyModal" class="modal hidden">
		<div class="reply-modal-content">
			<span class="close-button-modal cursor-pointer" onclick="closeModal('replyModal')">&times;</span>
			<h3 class="text-xl font-bold text-gray-800 mb-4">Responder Comentário</h3>
			<div class="comment-input-container">
				<div class="comment-profile-pic">
					{% if user.profile_image_url %}
						<img src="{{ user.profile_image_url }}" alt="Foto de perfil>" class="object-cover w-9 h-9 rounded-full">
					{% else %}
						<i class="fa-solid fa-user"></i>
					{% endif %}
				</div>
				<textarea id="replyTextarea" class="comment-textarea border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Escreva sua resposta!" oninput="adjustTextareaHeight(this); toggleReplyButton();"></textarea>
				<button id="replyButton" class="comment-button">Responder</button>
			</div>
		</div>
	</div>
	<div id="commentModal" class="modal hidden">
			<div class="reply-modal-content">
				<span class="close-button-modal cursor-pointer" onclick="closeModal('commentModal')">&times;</span>
				<div id="commentModalContent">
					<!-- Conteúdo do comentário e suas respostas será carregado aqui -->
				</div>
			</div>
		</div>
	<div id="postModal" class="modal hidden">
		<span class="post-close-button cursor-pointer" onclick="closeModal('postModal')">&times;</span>
		<div class="post-modal-content relative">
		</div>
	</div>
</body>
{% endblock %}
{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script src="{{ url_for('static', filename='postrequests.js') }}"></script>
<script>
	let bannerFile = null, removeBanner = false;
	let picFile = null, removePic = false;

	// Cropar imagens
	let cropper = null;
	let croppingType = null; // 'profile' ou 'banner'
	let croppedBlob = null;

	const cropModal = document.getElementById('cropModal');
	const cropImage = document.getElementById('cropImage');
	const applyCropBtn = document.getElementById('applyCropBtn');
	const cancelCropBtn = document.getElementById('cancelCropBtn');

	function openCropper(file, aspectRatio) {
		const reader = new FileReader();
		reader.onload = event => {
			cropImage.src = event.target.result;
			cropModal.classList.remove('hidden');
			if (cropper) cropper.destroy();
			cropper = new Cropper(cropImage, {
				aspectRatio: aspectRatio,
				viewMode: 1,
				autoCropArea: 1,
				movable: false,
				zoomable: true,
				scalable: false,
				rotatable: false,
				responsive: true,
				background: false,
			});
		};
		reader.readAsDataURL(file);
	}

	// Aplicar crop
	applyCropBtn.onclick = function () {
		if (!cropper) return;
		cropper.getCroppedCanvas().toBlob(blob => {
			croppedBlob = blob;
			if (croppingType === 'profile') {
				// Preview
				const url = URL.createObjectURL(blob);
				if (editProfilePicPreview.tagName === 'IMG') {
					editProfilePicPreview.src = url;
				} else {
					const img = document.createElement('img');
					img.id = 'editProfilePicPreview';
					img.src = url;
					img.className = 'object-cover w-full h-full';
					editProfilePicPreview.replaceWith(img);
				}
				// Salvar para envio
				picFile = blob;
			} else if (croppingType === 'banner') {
				const url = URL.createObjectURL(blob);
				editBannerPreview.src = url;
				editBannerPreview.classList.remove('hidden');
				removeBannerBtn.classList.remove('hidden');
				bannerFile = blob;
			}
			closeCropper();
		}, 'image/jpeg', 0.95);
	};

	cancelCropBtn.onclick = closeCropper;
	function closeCropper() {
		cropModal.classList.add('hidden');
		if (cropper) cropper.destroy();
		cropper = null;
		cropImage.src = '';
	}

	// Abrir modal
	const editBtn = document.getElementById('editProfileBtn');
	const modal = document.getElementById('editProfileModal');
	const form = document.getElementById('editProfileForm');
	const submitBtn = document.getElementById('submitEditProfileForm');
	const closeBtn = document.getElementById('closeEditProfileModal');
	
	// Banner
	const bannerBtn = document.getElementById('editBannerBtn');
	const bannerInput = document.getElementById('editBannerInput');
	const bannerPreview = document.getElementById('editBannerPreview');
	const removeBannerBtn = document.getElementById('removeBannerBtn');
	
	// Profile Pic
	const picBtn = document.getElementById('editProfilePicBtn');
	const editProfilePicInput = document.getElementById('editProfilePicInput');
	const picPreview = document.getElementById('editProfilePicPreview');

	// Abrir modal ao clicar em "Editar Perfil"
	if (editBtn) {
		editBtn.addEventListener('click', e => {
			e.preventDefault();
			document.getElementById('editBio').value = `${"{{ user.bio }}" != "None" ? "{{ user.bio }}" : ""}`;
			modal.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		});
	}
	// Fechar modal
	closeBtn.addEventListener('click', () => {
		modal.classList.add('hidden');
		document.body.style.overflow = '';
		resetEditProfileModal();
	});

	// Banner preview
	bannerBtn.addEventListener('click', () => bannerInput.click());
	bannerInput.addEventListener('change', e => {
		if (e.target.files && e.target.files[0]) {
			bannerFile = e.target.files[0];
			removeBanner = false;
			const reader = new FileReader();
			reader.onload = ev => {
				bannerPreview.src = ev.target.result;
				bannerPreview.classList.remove('hidden');
				removeBannerBtn.classList.remove('hidden');
			};
			reader.readAsDataURL(bannerFile);
		}
	});

	removeBannerBtn.addEventListener('click', () => {
		bannerFile = null;
		removeBanner = true;
		bannerPreview.src = '';
		bannerPreview.classList.add('hidden');
		removeBannerBtn.classList.add('hidden');
	})

	picBtn.addEventListener('click', () => editProfilePicInput.click());
	editProfilePicInput.addEventListener('change', e => {
		if (e.target.files && e.target.files[0]) {
			croppingType = 'profile';
			openCropper(e.target.files[0], 1);
		}
	});
	editBannerInput.addEventListener('change', e => {
		if (e.target.files && e.target.files[0]) {
			croppingType = 'banner';
			openCropper(e.target.files[0], 56 / 15);
		}
	});
	
	function resetEditProfileModal() {
		form.reset();
		bannerFile = null; removeBanner = false;
		picFile = null; removePic = false;
		if (bannerPreview) {
			{% if user.banner_url %}
			bannerPreview.src = "{{ user.banner_url }}";
			bannerPreview.classList.remove('hidden');
			removeBannerBtn.classList.remove('hidden');
			{% else %}
			bannerPreview.src = '';
			bannerPreview.classList.add('hidden');
			removeBannerBtn.classList.add('hidden');
			{% endif %}
		}
		if (picPreview) {
			{% if user.profile_image_url %}
			picPreview.src = "{{ user.profile_image_url }}";
			{% else %}
			const span = document.createElement('span');
			span.id = 'editProfilePicPreview';
			span.className = 'flex items-center justify-center w-full h-full text-blue-500 text-5xl';
			span.innerHTML = '<i class="fa-solid fa-user"></i>';
			picPreview.replaceWith(span);
			{% endif %}
		}
	}
	
	form.addEventListener('submit', async e => {
		e.preventDefault();
		toggleLoading(submitBtn);

		const displayName = document.getElementById('editDisplayName').value.trim();
		const bio = document.getElementById('editBio').value.trim();
		
		const formData = new FormData();
		formData.append('editDisplayName', displayName);
		formData.append('editBio', bio);
		if (typeof bannerFile !== 'undefined' && bannerFile) {
			formData.append('editBannerInput', bannerFile, 'banner.jpg');
		}
		if (removeBanner) formData.append('remove_banner', '1');
		if (typeof picFile !== 'undefined' && picFile) {
			formData.append('editProfilePicInput', picFile, 'profile.jpg');
		}
		// if (removePic) formData.append('remove_profile_image', '1');
		
		const oldErrorMessages = form.querySelectorAll('.error-message');
		oldErrorMessages.forEach(msg => msg.remove());
		form.querySelectorAll('input').forEach(input => input.classList.remove('border-red-500'));

		const result = await sendFormAsAjax(`/usuario/{{ user.id }}/editar`, formData);
		if (result.success) {
			location.reload();
		} else {
			const errorsContainer = document.getElementById("errors");
			for (const fieldName in result.errors) {
					const messages = result.errors[fieldName];
					
					const inputElement = document.getElementById(fieldName);
					if (inputElement) {
						inputElement.classList.add('border-red-500');
					}

					messages.forEach(msg => {
						const errorMessage = document.createElement('p');
						errorMessage.className = 'text-red-500 text-xs mt-1 error-message';
						errorMessage.textContent = msg;
						errorsContainer.appendChild(errorMessage);
					});
				}
		}
		toggleLoading(submitBtn);
	});
</script>
{% endblock %}

