{% extends "base.html" %}
{% block additional_styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    /* Estilos Gerais do Post (mantidos e ajustados) */
    body {
        font-family: 'Inter', sans-serif;
    }
    .post-content p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    
    .post-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
    }

    .post-content {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .modal {
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-out;
    }
    .modal.is-visible {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        animation: zoomIn 0.3s ease-out;
    }
    .close-button {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
        z-index: 10000;
    }
    .close-button:hover,
    .close-button:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }

    @keyframes fadeIn {
        from {opacity: 0;}
        to {opacity: 1;}
    }
    @keyframes zoomIn {
        from {transform: scale(0.8); opacity: 0;}
        to {transform: scale(1); opacity: 1;}
    }

    .interaction-button {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        border-radius: 9999px;
        color: #6B7280;
        background-color: #E5E7EB;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .interaction-button:hover:not(.active) {
        background-color: #DBEAFE;
        color: #3B82F6;
    }
    
    .interaction-button.active {
        background-color: #3B82F6;
        color: white;
    }

    .interaction-button.active .fa-thumbs-up,
    .interaction-button.active .fa-thumbs-down {
        color: white; 
    }

    .interaction-button i {
        font-size: 1.125rem;
    }

    .comment-input-container {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .comment-textarea {
        flex-grow: 1;
        resize: none;
        height: 2.5rem;
        overflow: hidden;
    }

    .comment-button {
        padding: 0.6rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        background-color: #E0E7FF;
        color: #6366F1;
        pointer-events: none;
        opacity: 0.6;
    }

    .comment-button.active {
        background-color: #3B82F6;
        color: white;
        pointer-events: auto;
        opacity: 1;
    }

    .comment-button:hover:not(.active) {
        background-color: #BFDBFE; 
        color: #2563EB; 
    }
    
    .share-context-menu {
        position: absolute;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0;
        z-index: 100;
        min-width: 180px;
        right: 0; 
        top: 100%;
        transform: translateY(0.5rem);
    }

    .share-context-menu button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.75rem 1rem;
        text-align: left;
        background-color: transparent;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        color: #374151;
    }

    .share-context-menu button:hover {
        background-color: #F3F4F6;
    }

    .reply-modal-content {
        background-color: white;
        border-radius: 0.5rem;
        padding: 2rem;
        position: relative;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease-out;
    }

    .reply-modal-content .comment-input-container {
        margin-top: 1.5rem;
    }

    .reply-modal-content .close-button-modal {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2rem;
        color: #9CA3AF;
        cursor: pointer;
        transition: color 0.2s;
    }
    .reply-modal-content .close-button-modal:hover {
        color: #4B5563;
    }
    
    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .comment-profile-pic {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 9999px;
        background-color: #D1D5DB;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6B7280;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    
    .comment-reply {
        margin-left: 3rem;
        border-left: 2px solid #E5E7EB;
        padding-left: 1rem;
        margin-top: 1rem;
    }
</style>
{% endblock %}
{% block content %}
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-3xl">
        <div class="flex justify-between items-start md:items-center mb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2 md:mb-0">{{ post.title }}</h1>
            <span class="text-gray-500 text-sm md:text-base">
                {{ post.created_at.strftime('%b %d, %Y') }}
            </span>
        </div>

        <div class="flex flex-wrap gap-2 mb-6">
            <span class="bg-blue-500 text-white text-xs font-semibold px-3 py-1 rounded-full">
                {{ post.tag.upper() }}
            </span>
            {% if post.optional_tags %}
                {% for tag in post.optional_tags.split(',') %}
                    {% if tag.strip() %}
                        <span class="bg-gray-300 text-gray-800 text-xs font-semibold px-3 py-1 rounded-full">
                            {{ tag.strip().upper() }}
                        </span>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <div class="post-content text-gray-700 leading-relaxed text-base md:text-lg mb-8">{{ post.content | trim }}</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            {% if post.image_urls %}
                {% for image_url in post.image_urls %}
                    <div class="bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center h-48 md:h-64 cursor-pointer hover:opacity-90 transition-opacity" onclick="openModal('imageModal', '{{ image_url }}')">
                        <img src="{{ image_url }}" alt="Imagem do Post" class="object-cover w-full h-full">
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="my-2 text-gray-600 text-sm">
            Postado por: <span class="font-semibold">{{ post.author_user.username }}</span>
        </div>

        <div class="flex items-center gap-4 border-t border-gray-200 pt-4 mb-8">
            <button class="interaction-button {% if user_post_reaction == 'like_post' %}active{% endif %}" id="likeButton">
                <i class="fa-solid fa-thumbs-up"></i>
                <span id="likeCount">{{ post_likes }}</span>
            </button>
            <button class="interaction-button {% if user_post_reaction == 'dislike_post' %}active{% endif %}" id="dislikeButton">
                <i class="fa-solid fa-thumbs-down"></i>
                <span id="dislikeCount">{{ post_dislikes }}</span>
            </button>
            <div class="relative">
                <button class="interaction-button" id="shareButton">
                    <i class="fa-solid fa-share-alt"></i>
                    <span>Compartilhar</span>
                </button>
                <div id="shareContextMenu" class="share-context-menu hidden">
                    <button onclick="copyPostUrl()">
                        <i class="fa-solid fa-copy"></i>
                        Copiar URL do Post
                    </button>
                </div>
            </div>
            <button class="interaction-button" id="saveButton">
                <i class="fa-solid fa-bookmark"></i>
                <span>Salvar</span>
            </button>
        </div>

        <div class="comment-input-container mb-8">
            <div class="comment-profile-pic">
                <i class="fa-solid fa-user"></i>
            </div>
            <textarea id="commentTextarea" class="comment-textarea border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Escreva um comentário!" oninput="adjustTextareaHeight(this); toggleCommentButton();"></textarea>
            <button id="commentButton" class="comment-button">Comentar</button>
        </div>

        <div class="border-t border-blue-200 mb-8"></div>

        <div id="commentsSection">
            {% for comment in comments %}
            <div class="comment-item flex gap-4 mb-6" data-comment-id="{{ comment.id }}">
                <div class="comment-profile-pic">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="flex-grow">
                    <p class="font-semibold text-gray-800 mb-1">{{ comment.username }}</p>
                    <p class="text-gray-700 mb-2">{{ comment.content }}</p>
                    <div class="flex items-center gap-4 text-sm text-gray-500">
                        <button class="interaction-button comment-like-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500 {% if comment.user_reaction == 'like_comment' %}active{% endif %}" id="interaction{{ comment.id }}likeButton">
                            <i class="fa-solid fa-thumbs-up"></i> <span class="comment-like-count" id="interaction{{ comment.id }}likeCount">{{ comment.likes }}</span>
                        </button>
                        <button class="interaction-button comment-dislike-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500 {% if comment.user_reaction == 'dislike_comment' %}active{% endif %}" id="interaction{{ comment.id }}dislikeButton">
                            <i class="fa-solid fa-thumbs-down"></i> <span class="comment-dislike-count" id="interaction{{ comment.id }}dislikeCount">{{ comment.dislikes }}</span>
                        </button>
                        <button class="interaction-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500" onclick="openReplyModal('{{ comment.id }}')">
                            <i class="fa-solid fa-reply"></i>
                        </button>
                        <button class="interaction-button comment-save-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500">
                            <i class="fa-solid fa-bookmark"></i>
                        </button>
                    </div>
                    
                    {% if comment.replies %}
                        {% for reply in comment.replies %}
                        <div class="comment-item flex gap-4 mt-4 comment-reply" data-comment-id="{{ reply.id }}" data-user-reaction="{{ reply.user_reaction or '' }}">
                            <div class="comment-profile-pic">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800 mb-1">{{ reply.username }}</p>
                                <p class="text-gray-700 mb-2">{{ reply.content }}</p>
                                <div class="flex items-center gap-4 text-sm text-gray-500">
                                    <button class="interaction-button comment-like-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500 {% if reply.user_reaction == 'like_comment' %}active{% endif %}" id="interaction{{ reply.id }}likeButton">
                                        <i class="fa-solid fa-thumbs-up"></i> <span class="comment-like-count" id="interaction{{ reply.id }}likeCount">{{ reply.likes }}</span>
                                    </button>
                                    <button class="interaction-button comment-dislike-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500 {% if reply.user_reaction == 'dislike_comment' %}active{% endif %}" id="interaction{{ reply.id }}dislikeButton">
                                        <i class="fa-solid fa-thumbs-down"></i> <span class="comment-dislike-count" id="interaction{{ reply.id }}dislikeCount">{{ reply.dislikes }}</span>
                                    </button>
                                    <button class="interaction-button comment-reply-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500" onclick="openReplyModal('{{ reply.id }}')">
                                        <i class="fa-solid fa-reply"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {# Fim da Seção de Comentários Existentes #}

        <div class="mt-8 text-center">
            <a href="{{ url_for('main.index') }}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 ease-in-out">
                Voltar para a página inicial
            </a>
        </div>
    </div>

    <div id="imageModal" class="modal hidden">
        <span class="close-button" onclick="closeModal('imageModal')">&times;</span>
        <img class="modal-content" id="fullImage">
    </div>

    <div id="replyModal" class="modal hidden">
        <div class="reply-modal-content">
            <span class="close-button-modal" onclick="closeModal('replyModal')">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Responder Comentário</h3>
            <div class="comment-input-container">
                <div class="comment-profile-pic">
                    <i class="fa-solid fa-user"></i>
                </div>
                <textarea id="replyTextarea" class="comment-textarea border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Escreva sua resposta!" oninput="adjustTextareaHeight(this); toggleReplyButton();"></textarea>
                <button id="replyButton" class="comment-button">Responder</button>
            </div>
        </div>
    </div>

    <script>
        // Auxiliares

        function toggleLoading(buton) {
            const hasSpinner = button.querySelector('.loading-spinner');
            if (hasSpinner) {
                hasSpinner.remove();
            } else {
                const spinner = document.createElement('span');
                spinner.className = 'loading-spinner';
                spinner.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                button.appendChild(spinner);
            }
        }

        // Funções para Modais (ajustadas para aceitar ID do modal)
        function openModal(modalId, imageSrc = null) {
            const modal = document.getElementById(modalId);
            if (modalId === 'imageModal') {
                const fullImage = document.getElementById('fullImage');
                fullImage.src = imageSrc;
            }
            modal.classList.remove('hidden');
            modal.classList.add('is-visible');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hidden');
            modal.classList.remove('is-visible');
            // Resetar textareas dos modais ao fechar para evitar estados persistentes
            if (modalId === 'replyModal') {
                resetTextarea(document.getElementById('replyTextarea'));
                toggleReplyButton();
            }
        }

        // Fecha modais ao clicar fora
        document.addEventListener('click', function(event) {
            // Fechar modal de imagem
            const imageModal = document.getElementById('imageModal');
            if (imageModal && imageModal.classList.contains('is-visible') && !imageModal.querySelector('.modal-content').contains(event.target) && event.target.id === 'imageModal') {
                closeModal('imageModal');
            }
            
            // Fechar modal de resposta
            const replyModal = document.getElementById('replyModal');
            if (replyModal && replyModal.classList.contains('is-visible') && !replyModal.querySelector('.reply-modal-content').contains(event.target) && event.target.id === 'replyModal') {
                closeModal('replyModal');
            }

            // Fechar o menu de compartilhamento se clicar fora de ambos os elementos
            const shareContextMenu = document.getElementById('shareContextMenu');
            const shareButton = document.getElementById('shareButton');
            if (shareContextMenu && !shareContextMenu.classList.contains('hidden') && !shareContextMenu.contains(event.target) && event.target !== shareButton) {
                shareContextMenu.classList.add('hidden');
            }
        });

        // Fecha modais ao pressionar a tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal('imageModal');
                closeModal('replyModal');
            }
        });

        // --- Funções de Interatividade dos Botões Principais (Like, Dislike, Salvar) ---

        function toggleButtonActive(buttonElement) {
            if (buttonElement) {
                buttonElement.classList.toggle('active');
            }
        }

        document.getElementById('saveButton').addEventListener('click', function() {
            toggleButtonActive(this);
            console.log('Botão Salvar do Post clicado!');
            // Lógica de backend aqui
        });

        function visualReactionUpdate(selfType, oppositeType) { 
            const oppositeCount = document.getElementById(oppositeType + "Count");
            const selfCount = document.getElementById(selfType + "Count");

            const opposite = document.getElementById(oppositeType + "Button");
            if (opposite.classList.contains('active')) { // Se a reação oposta estiver ativa....
                oppositeCount.textContent = Number(oppositeCount.textContent) - 1; // Na hora de converter os valores de 1000 pra 1k isso não vai funcionar mais, então talvez seja necessário criar um data-quanitity pra saber o valor numérico
                opposite.classList.remove('active'); // Caso o botão de deslike esteja ativado :P
            }
            selfCount.textContent = Number(selfCount.textContent) + 1;
        }

        function formatCount(count) {
            if (count >= 1000 && count < 1000000) {
                return (count / 1000).toFixed(1) + 'K';
            } else if (count >= 1000000) {
                return (count / 1000000).toFixed(1) + 'M'; // Não custa sonhar né
            }
            return count;
        }

        // --- Compartilhamento ---
        document.getElementById('shareButton').addEventListener('click', function(event) {
            event.stopPropagation(); // Evita que o clique se propague para o document e feche o menu imediatamente
            const contextMenu = document.getElementById('shareContextMenu');
            contextMenu.classList.toggle('hidden');
        });

        function copyPostUrl() {
            const dummy = document.createElement('textarea');
            const postUrl = window.location.href;
            document.body.appendChild(dummy);
            dummy.value = postUrl;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            alert('URL do post copiada para a área de transferência!');
            document.getElementById('shareContextMenu').classList.add('hidden'); // Fecha o menu após copiar
        }

        // --- Funções de Comentário ---

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function resetTextarea(textarea) {
            textarea.value = '';
            textarea.style.height = 'unset';
        }

        function toggleCommentButton() {
            const textarea = document.getElementById('commentTextarea');
            const button = document.getElementById('commentButton');
            if (textarea.value.trim().length > 0) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }

        function toggleReplyButton() {
            const textarea = document.getElementById('replyTextarea');
            const button = document.getElementById('replyButton');
            if (textarea.value.trim().length > 0) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }

        document.getElementById('commentTextarea').addEventListener('input', toggleCommentButton);
        document.getElementById('replyTextarea').addEventListener('input', toggleReplyButton);
        
        // Pegar CSRF token da meta tag
        function getCsrfToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        // Função genérica para enviar requisições AJAX (sem prazo pra estudar jQuery)
        async function sendApiRequest(url, method, data) {
            const csrfToken = getCsrfToken();
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('Erro na requisição API:', error);
                return { success: false, message: 'Erro de comunicação com o servidor.' };
            }
        }

        // --- Adaptação das chamadas de API para usar sendApiRequest ---

        document.getElementById('likeButton').addEventListener('click', async function() {
            const postId = "{{ post.id }}";

            toggleButtonActive(this); 
            visualReactionUpdate('like', 'dislike');

            const data = { reaction_type: 'like_post' };
            const result = await sendApiRequest(`/api/posts/${postId}/react`, 'POST', data);
            if (result.success) {
                updatePostCounts(postId);
            } else {
                alert('Erro durante a reação, nenhuma alteração foi feita: ' + result.message);
            }
        });

        document.getElementById('dislikeButton').addEventListener('click', async function() {
            const postId = "{{ post.id }}";

            toggleButtonActive(this); 
            visualReactionUpdate('dislike', 'like');
            
            const data = { reaction_type: 'dislike_post' };
            const result = await sendApiRequest(`/api/posts/${postId}/react`, 'POST', data);
            if (result.success) {
                updatePostCounts(postId);
            } else {
                alert('Erro durante a reação, nenhuma alteração foi feita: ' + result.message);
            }
        });

        document.getElementById('commentButton').addEventListener('click', async function() {
            if (this.classList.contains('active')) {
                const commentText = document.getElementById('commentTextarea').value.trim();
                const postId = "{{ post.id }}";

                resetTextarea(document.getElementById('commentTextarea'));
                toggleCommentButton();
                toggleLoading(this);
                
                const data = { comment_text: commentText };
                const result = await sendApiRequest(`/api/posts/${postId}/comment`, 'POST', data);
                if (result.success) {
                    await refreshCommentsSection(); // Recarregar a seção de comentários para adicionar o novo
                } else {
                    alert('Erro: ' + result.message);
                }
            }
        });

        document.getElementById('replyButton').addEventListener('click', async function() {
            if (this.classList.contains('active')) {
                const replyText = document.getElementById('replyTextarea').value.trim();
                const parentCommentId = document.getElementById('replyModal').dataset.parentCommentId; 
                
                if (!parentCommentId) {
                    alert("Erro: ID do comentário pai não encontrado.");
                    return;
                }

                closeModal('replyModal');
                const data = { reply_text: replyText };
                const result = await sendApiRequest(`/api/comments/${parentCommentId}/reply`, 'POST', data);
                
                if (result.success) {
                    await refreshCommentsSection(); // Recarregar a seção de comentários
                } else {
                    alert('Erro: ' + result.message);
                }
            }
        });

        // Abre a interface de respostas e armazena o ID do comentário a ser respondido
        function openReplyModal(parentCommentId) {
            const replyModal = document.getElementById('replyModal');
            replyModal.dataset.parentCommentId = parentCommentId; 
            openModal('replyModal');
        }

        // Evento de clique para os botões de resposta dos comentários
        document.getElementById('commentsSection').addEventListener('click', function(event) {
            const clickedButton = event.target.closest('.comment-like-button, .comment-dislike-button, .comment-save-button, .comment-reply-button');

            if (clickedButton) {
                const commentItem = clickedButton.closest('.comment-item');
                const commentId = commentItem ? commentItem.dataset.commentId : null; // Eu acho esse forma de if else muito funny

                if (clickedButton.classList.contains('comment-reply-button')) {
                    openReplyModal(commentId); // Resposta de comentário
                } else {
                    toggleButtonActive(clickedButton);

                    if (clickedButton.classList.contains('comment-like-button')) {
                        visualReactionUpdate(`interaction${commentId}like`, `interaction${commentId}dislike`); // Like
                        handleCommentReaction(commentId, 'like_comment');
                    } else if (clickedButton.classList.contains('comment-dislike-button')) {
                        visualReactionUpdate(`interaction${commentId}dislike`, `interaction${commentId}like`); // Deslike
                        handleCommentReaction(commentId, 'dislike_comment');
                    } else if (clickedButton.classList.contains('comment-save-button')) {
                        // Lógica para salvar comentário
                        alert(`Botão Salvar Comentário ${commentId} clicado! (Lógica backend a ser implementada)`);
                    }
                }
            }
        });

        async function handleCommentReaction(commentId, reactionType) {
            const data = { reaction_type: reactionType };
            const result = await sendApiRequest(`/api/comments/${commentId}/react`, 'POST', data);

            if (result.success) {
                await updateCommentCounts(commentId);
            } else {
                alert('Erro: ' + result.message);
            }
        }

        // Função para recarregar a seção de comentários (usada após adicionar um novo comentário/resposta)
        async function refreshCommentsSection() {
            const postId = "{{ post.id }}";
            const response = await fetch(`/api/posts/${postId}/comments`); 
            const data = await response.json();
            
            if (data.success) {
                const commentsSection = document.getElementById('commentsSection');
                commentsSection.innerHTML = ''; // Limpa a seção atual
                data.comments.forEach(comment => {
                    commentsSection.innerHTML += renderComment(comment); // Adiciona cada comentário
                });

                document.querySelectorAll('textarea').forEach(textarea => {
                    resetTextarea(textarea);
                });
                toggleCommentButton();
                toggleReplyButton();
            } else {
                alert('Erro ao recarregar comentários: ' + data.message);
            }
        }

        // Função para atualizar contagens e estado dos botões de post
        async function updatePostCounts(postId) {
            const response = await fetch(`/api/posts/${postId}/counts`);
            const data = await response.json();
            if (data.success) {
                document.getElementById('likeCount').textContent = data.likes;
                document.getElementById('dislikeCount').textContent = data.dislikes;

                const likeButton = document.getElementById('likeButton');
                const dislikeButton = document.getElementById('dislikeButton');

                // Remove as classes ativas antes de adicionar, para garantir o estado correto
                likeButton.classList.remove('active');
                dislikeButton.classList.remove('active');

                if (data.user_reaction === 'like_post') {
                    likeButton.classList.add('active');
                } else if (data.user_reaction === 'dislike_post') {
                    dislikeButton.classList.add('active');
                }
            }
        }

        // Nova função para atualizar contagens e estado dos comentários
        async function updateCommentCounts(commentId) {
            const response = await fetch(`/api/comments/${commentId}/counts`);
            const data = await response.json();
            if (data.success) {
                const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
                if (commentItem) {
                    commentItem.querySelector('.comment-like-count').textContent = data.likes;
                    commentItem.querySelector('.comment-dislike-count').textContent = data.dislikes;
                    
                    const likeButton = commentItem.querySelector('.comment-like-button');
                    const dislikeButton = commentItem.querySelector('.comment-dislike-button');

                    if (dislikeButton && likeButton) {
                        likeButton.classList.remove('active');
                        dislikeButton.classList.remove('active');

                        if (data.user_reaction === 'like_comment') {
                            likeButton.classList.add('active');
                        } else if (data.user_reaction === 'dislike_comment') {
                            dislikeButton.classList.add('active');
                        }
                    }
                }
            }
        }
        
        // Função para recarregar a seção de comentários
        async function handleCommentReaction(commentId, reactionType, clickedButton, commentItem) {
            const data = { reaction_type: reactionType };
            const result = await sendApiRequest(`/api/comments/${commentId}/react`, 'POST', data);

            if (result.success) {
                await updateCommentCounts(commentId); // Isso buscará o estado atualizado do backend
            } else {
                alert('Erro: ' + result.message);
            }
        }

        // Função auxiliar para renderizar um único comentário (ou resposta)
        function renderComment(comment) {
            // Determinar classes 'active' baseadas no user_reaction retornado pelo backend
            const commentLikeActiveClass = comment.user_reaction === 'like_comment' ? 'active' : '';
            const commentDislikeActiveClass = comment.user_reaction === 'dislike_comment' ? 'active' : '';

            let html = `
                <div class="comment-item flex gap-4 mb-6" data-comment-id="${comment.id}">
                    <div class="comment-profile-pic">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800 mb-1">${comment.username}</p>
                        <p class="text-gray-700 mb-2">${comment.content}</p>
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                            <button class="interaction-button comment-like-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500 ${commentLikeActiveClass}" id="interaction${comment.id}likeButton">
                                <i class="fa-solid fa-thumbs-up"></i> <span class="comment-like-count" id="interaction${comment.id}likeCount">${comment.likes || 0}</span>
                            </button>
                            <button class="interaction-button comment-dislike-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500 ${commentDislikeActiveClass}" id="interaction${comment.id}dislikeButton">
                                <i class="fa-solid fa-thumbs-down"></i> <span class="comment-dislike-count" id="interaction${comment.id}dislikeCount">${comment.dislikes || 0}</span>
                            </button>
                            <button class="interaction-button comment-reply-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500" onclick="openReplyModal('${comment.id}')">
                                <i class="fa-solid fa-reply"></i>
                            </button>
                            <button class="interaction-button comment-save-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500">
                                <i class="fa-solid fa-bookmark"></i>
                            </button>
                        </div>
            `;
            
            if (comment.replies && comment.replies.length > 0) {
                comment.replies.forEach(reply => {
                    const replyLikeActiveClass = reply.user_reaction === 'like_comment' ? 'active' : '';
                    const replyDislikeActiveClass = reply.user_reaction === 'dislike_comment' ? 'active' : '';

                    html += `
                        <div class="comment-item flex gap-4 mt-4 comment-reply" data-comment-id="${reply.id}">
                            <div class="comment-profile-pic">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800 mb-1">${reply.username}</p>
                                <p class="text-gray-700 mb-2">${reply.content}</p>
                                <div class="flex items-center gap-4 text-sm text-gray-500">
                                    <button class="interaction-button comment-like-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500 ${replyLikeActiveClass}" id="interaction${reply.id}likeButton">
                                        <i class="fa-solid fa-thumbs-up"></i> <span class="comment-like-count" id="interaction${reply.id}likeCount">${reply.likes || 0}</span>
                                    </button>
                                    <button class="interaction-button comment-dislike-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500 ${replyDislikeActiveClass}" id="interaction${reply.id}dislikeButton">
                                        <i class="fa-solid fa-thumbs-down"></i> <span class="comment-dislike-count" id="interaction${reply.id}dislikeCount">${reply.dislikes || 0}</span>
                                    </button>
                                    <button class="interaction-button comment-reply-button px-2 py-1 bg-transparent hover:bg-blue-100 hover:text-blue-500" onclick="openReplyModal('${reply.id}')">
                                        <i class="fa-solid fa-reply"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            return html;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const postId = "{{ post.id }}";
            document.querySelectorAll('textarea').forEach(textarea => {
                adjustTextareaHeight(textarea);
            });
            toggleCommentButton();
            toggleReplyButton();
        });
    </script>
</body>
{% endblock %}